USE [ENGAGENBSF]
GO
/****** Object:  StoredProcedure [ENGAGENBSF].[PA_TR11_RPT_EXP_ADJ]    Script Date: 01/24/2019 12:15:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE 	[ENGAGENBSF].[PA_TR11_RPT_EXP_ADJ](
	@PKEY_JOB VARCHAR(100),
	@USER_ID VARCHAR(30),
	@RET_MESSAGE VARCHAR(440) = NULL OUTPUT )
WITH EXECUTE AS CALLER
AS
-- =========================================================================================================================
-- AUTOR: Barboza Carvalho, Pablo Alejandro -- RPOCHOA
-- FECHA DE CREACIÓN: 14/06/2016
-- TABLAS LEÍDAS:
-- TABLAS MODIFICADAS:
-- DESCRIPCIÓN: EXPORTA LOS DATOS PARA LA REASIGNACION DE ATT.
-- =========================================================================================================================
SET NOCOUNT ON;
SET XACT_ABORT ON;

-- DECLARA LAS VARIABLES.
DECLARE
@LS_PAR_KEY VARCHAR(100),
@LS_PKEY_LISTA	VARCHAR(36), 
@LS_DESCRIP VARCHAR(250),
@LS_FILE_NAME VARCHAR(255),
@LS_USER_ID VARCHAR(30),
@LO_ATTACHMENT VARBINARY(MAX),
@LS_QUERY VARCHAR(8000),
@LS_ROW_HEADER VARCHAR(4000),
@LS_FILE_FORMAT VARCHAR(3),
@LS_RET_MESSAGE VARCHAR(440),
@JOB_TYPE		VARCHAR(20),
@P_OUT_FLUJO	VARCHAR(20)

BEGIN

SELECT 
	@LS_PAR_KEY = PKEY,
	@LS_USER_ID = USER_ID,
	@JOB_TYPE = JOB_TYPE_CODE
FROM PHYSICAL_JOB
WHERE PKEY = (SELECT PARENT_JOB_PKEY FROM PHYSICAL_JOB WHERE PKEY = @PKEY_JOB)


-- ASIGNA VALORES PREDETERMINADOS A LAS VARIABLES.
SELECT	--@LS_PAR_KEY = @PKEY_JOB,
	--@LS_USER_ID = @USER_ID,
	@LO_ATTACHMENT	= NULL,
	@LS_FILE_FORMAT = 'XLS',--'TSV',--CSV TXT	
	@LS_RET_MESSAGE = NULL;

--SET @LS_QUERY = 'SELECT '

IF @JOB_TYPE = 'TR4'
BEGIN	
SELECT
		@LS_QUERY		= 'SELECT '+ QUERY_EXPORTAR,
		@LS_ROW_HEADER	= HEADER,
		@LS_FILE_NAME	= FILE_NAME_ATTACHED
	FROM TMT_TR4 
	WHERE PAR_KEY		= @LS_PAR_KEY
END

IF @JOB_TYPE = 'AC03'
BEGIN
	SELECT	@LS_QUERY		= 'SELECT '+QUERY_EXPORTAR,
			@LS_ROW_HEADER	= HEADER,
			@LS_FILE_NAME	= FILE_NAME_ATTACHED
	FROM	TMT_AC03 
	WHERE	PAR_KEY	= @LS_PAR_KEY
END

PRINT @LS_QUERY
PRINT @LS_ROW_HEADER

IF @JOB_TYPE IN ('TR4', 'AC03')
BEGIN
-- SP DE PRODUCTO QUE GENERE ADJUNTOS A PARTIR DE UNA SERIE DE PARÁMETROS. LEER LA DOCUMENTACIÓN DE ESTE SP PARA ENTENDER EL CONJUNTO COMPLETO DE PARAMETROS, EN PARTICULAR LO S QUE REGULAN EL PROCESAMIENTO DE LOTES EN EL PROCESAMIENTO TRANSACCIONAL QUE INSERTA LOS DATOS DEL ADJUNTO.
EXECUTE PA_SYS_WRITE_ATTACHMENT_TEMP @PS_PAR_KEY = @LS_PAR_KEY, @PS_DESCRIP = @LS_FILE_NAME, @PS_FILE_NAME = @LS_FILE_NAME, @PS_USER_ID = @LS_USER_ID, @PO_ATTACHMENT = @LO_ATTACHMENT, @PS_QUERY = @LS_QUERY, @PS_ROW_HEADER = @LS_ROW_HEADER, @PS_FILE_FORMAT = @LS_FILE_FORMAT, @PS_RET_MESSAGE = @LS_RET_MESSAGE OUTPUT;
SELECT @LS_RET_MESSAGE;
END

IF @JOB_TYPE = 'CC03'
BEGIN
EXECUTE	PA_IMP_EXTRAER_DATA
		@LS_PAR_KEY,
		@JOB_TYPE,
		@P_OUT_FLUJO OUTPUT,
		@RET_MESSAGE OUTPUT
END

END 

